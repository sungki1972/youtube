<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 파일 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">생성된 MP3 파일 목록</h1>
                    <div class="flex space-x-2">
                        <button onclick="refreshFiles()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            새로고침
                        </button>
                        <a href="/api.html" 
                           class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                            새 MP3 생성
                        </a>
                    </div>
                </div>
                
                <div id="loading" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-gray-600">파일 목록을 불러오는 중...</p>
                </div>
                
                <div id="fileList" class="hidden">
                    <div id="fileCount" class="mb-4 text-sm text-gray-600"></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">파일명</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">크기</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">생성일시</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">다운로드</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">재생</th>
                                </tr>
                            </thead>
                            <tbody id="fileTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 파일 목록이 여기에 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="noFiles" class="text-center py-8 hidden">
                    <p class="text-gray-500">생성된 MP3 파일이 없습니다.</p>
                    <a href="/api.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        첫 MP3 생성하기
                    </a>
                </div>
                
                <div id="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded hidden">
                    <p id="errorMessage">파일 목록을 불러오는 중 오류가 발생했습니다.</p>
                </div>
            </div>
            
            <!-- 다운로드 통계 -->
            <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold mb-4">통계</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="totalFiles">0</div>
                        <div class="text-sm text-gray-600">총 파일 수</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="totalSize">0 MB</div>
                        <div class="text-sm text-gray-600">총 파일 크기</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="latestFile">-</div>
                        <div class="text-sm text-gray-600">최근 생성</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAudio = null;

        // 페이지 로드 시 파일 목록 불러오기
        document.addEventListener('DOMContentLoaded', function() {
            loadFiles();
        });

        // 파일 목록 로드
        async function loadFiles() {
            try {
                showLoading();
                const response = await fetch('/api/files');
                const data = await response.json();
                
                if (data.success) {
                    displayFiles(data.files);
                    updateStatistics(data.files);
                } else {
                    showError('파일 목록을 불러올 수 없습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('네트워크 오류가 발생했습니다.');
            }
        }

        // 파일 목록 표시
        function displayFiles(files) {
            const loadingDiv = document.getElementById('loading');
            const fileListDiv = document.getElementById('fileList');
            const noFilesDiv = document.getElementById('noFiles');
            const errorDiv = document.getElementById('error');
            const fileTableBody = document.getElementById('fileTableBody');
            const fileCountDiv = document.getElementById('fileCount');

            loadingDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            if (files.length === 0) {
                fileListDiv.classList.add('hidden');
                noFilesDiv.classList.remove('hidden');
                return;
            }

            noFilesDiv.classList.add('hidden');
            fileListDiv.classList.remove('hidden');
            
            fileCountDiv.textContent = `총 ${files.length}개의 MP3 파일`;
            
            fileTableBody.innerHTML = '';
            
            files.forEach(file => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const fileName = file.fileName.length > 50 ? 
                    file.fileName.substring(0, 50) + '...' : file.fileName;
                
                const fileSize = (file.fileSize / 1024 / 1024).toFixed(2);
                const createdDate = new Date(file.createdAt).toLocaleString('ko-KR');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" title="${file.fileName}">
                        ${fileName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${fileSize} MB
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${createdDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="${file.downloadUrl}" download="${file.fileName}"
                           class="inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            다운로드
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="togglePlay('${file.downloadUrl}', this)" 
                                class="inline-flex items-center px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a1 1 0 011-1h4a1 1 0 011 1v1M9 10v5a1 1 0 001 1h4a1 1 0 001-1v-5m-4 0V8a1 1 0 011-1h2a1 1 0 011 1v2"></path>
                            </svg>
                            재생
                        </button>
                    </td>
                `;
                
                fileTableBody.appendChild(row);
            });
        }

        // 통계 업데이트
        function updateStatistics(files) {
            const totalFiles = files.length;
            const totalSize = files.reduce((sum, file) => sum + file.fileSize, 0);
            const latestFile = files.length > 0 ? 
                new Date(files[0].createdAt).toLocaleDateString('ko-KR') : '-';

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('latestFile').textContent = latestFile;
        }

        // MP3 재생/정지
        function togglePlay(url, button) {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                resetAllPlayButtons();
                return;
            }

            if (currentAudio) {
                currentAudio.pause();
                resetAllPlayButtons();
            }

            currentAudio = new Audio(url);
            currentAudio.play().catch(error => {
                console.error('재생 오류:', error);
                alert('MP3 재생 중 오류가 발생했습니다.');
            });

            button.innerHTML = `
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"></path>
                </svg>
                정지
            `;

            currentAudio.onended = () => {
                resetAllPlayButtons();
            };
        }

        // 모든 재생 버튼 초기화
        function resetAllPlayButtons() {
            const playButtons = document.querySelectorAll('button[onclick*="togglePlay"]');
            playButtons.forEach(button => {
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10V9a1 1 0 011-1h4a1 1 0 011 1v1M9 10v5a1 1 0 001 1h4a1 1 0 001-1v-5m-4 0V8a1 1 0 011-1h2a1 1 0 011 1v2"></path>
                    </svg>
                    재생
                `;
            });
        }

        // 새로고침
        function refreshFiles() {
            loadFiles();
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('fileList').classList.add('hidden');
            document.getElementById('noFiles').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
        }

        // 오류 표시
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('fileList').classList.add('hidden');
            document.getElementById('noFiles').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>
